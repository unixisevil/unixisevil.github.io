<!DOCTYPE html>
<html lang="en">

<head>
    <title>Random Notes</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="robots" content="noodp"/>

    <link rel="stylesheet" href="https://unixisevil.github.io/style.css">
    <link rel="stylesheet" href="https://unixisevil.github.io/color/blue.css">

    <link rel="stylesheet" href="https://unixisevil.github.io/font-hack-subset.css">

    </head>

<body class="">
<div class="container">
    
    <header class="header">
        <div class="header__inner">
            <div class="header__logo">
                    
                <a href="https://unixisevil.github.io" style="text-decoration: none;">
                    <div class="logo">
                      
                            Random Notes
                        
                    </div>
                </a>
            </div>
        </div>

        
        
                <nav class="menu">
            <ul class="menu__inner">
                <li><a href="https://unixisevil.github.io">blog</a></li>
            
                <li><a href="https://unixisevil.github.io/tags">tags</a></li>
            
                <li><a href="https://unixisevil.github.io/archive">archive</a></li>
            
                <li><a href="https://my.oschina.net/evilunix">old blog</a></li>
            
                <li class="active"><a href="https://unixisevil.github.io/" target="_blank" rel="noopener noreferrer">github</a></li>
            </ul>
        </nav>
    
    
        
    </header>
    

    <div class="content">
        
    <div class="post">
        
    <h1 class="post-title"><a href="https://unixisevil.github.io/rpi4-uboot-kernel/">为raspberry pi 4 交叉编译, 构建u-boot 和 linux 内核</a></h1>
    <div class="post-meta-inline">
        
    <span class="post-date">
            2021-06-27
        </span>

    </div>

    
        <span class="post-tags-inline">
                :: tags:&nbsp;
                <a class="post-tag" href="https://unixisevil.github.io/tags/kernel/">#kernel</a>&nbsp;
                <a class="post-tag" href="https://unixisevil.github.io/tags/raspberry-pi/">#raspberry pi</a>&nbsp;
                <a class="post-tag" href="https://unixisevil.github.io/tags/u-boot/">#u-boot</a></span>
    

        
        <div class="post-content">
            <ol>
<li>编译u-boot 启动管理器：</li>
</ol>
<pre data-lang="bash" style="background-color:#151515;color:#e8e8d3;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffb964;">git</span><span>   clone  git://git.denx.de/u-boot.git
</span><span>cd  u-boot  
</span><span style="color:#ffb964;">make</span><span>  rpi_4_defconfig 
</span><span style="color:#ffb964;">CROSS_COMPILE</span><span>=</span><span style="color:#99ad6a;">aarch64-rpi4-linux-gnu-  </span><span style="color:#ffb964;">make -j8
</span></code></pre>
<p>编译后生成u-boot 相关文件:</p>
<pre data-lang="bash" style="background-color:#151515;color:#e8e8d3;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffb964;">u-boot</span><span>  u-boot.bin  u-boot.cfg  u-boot.cfg.configs  u-boot.lds  u-boot.map  u-boot-nodtb.bin  u-boot.srec  u-boot.sym
</span></code></pre>
<p>其中的u-boot.bin  是需要放到SD卡启动分区的启动管理器二进制文件</p>
<ol start="2">
<li>编译raspberry pi foundation 的内核:</li>
</ol>
<pre data-lang="bash" style="background-color:#151515;color:#e8e8d3;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffb964;">git</span><span> clone</span><span style="color:#ffb964;"> --depth</span><span>=1</span><span style="color:#ffb964;"> -b</span><span> rpi-5.10.y  https://github.com/raspberrypi/linux.git
</span><span>cd  linux
</span><span style="color:#ffb964;">make</span><span> ARCH=arm64 CROSS_COMPILE=aarch64-rpi4-linux-gnu-   bcm2711_defconfig
</span><span style="color:#ffb964;">make</span><span> ARCH=arm64 CROSS_COMPILE=aarch64-rpi4-linux-gnu-</span><span style="color:#ffb964;">  -j8
</span></code></pre>
<ol start="3">
<li>准备SD卡启动分区中的文件:</li>
</ol>
<pre data-lang="bash" style="background-color:#151515;color:#e8e8d3;" class="language-bash "><code class="language-bash" data-lang="bash"><span>cd  </span><span style="color:#ffb964;">~
</span><span style="color:#ffb964;">sudo</span><span> apt install subversion
</span><span style="color:#ffb964;">svn</span><span> export https://github.com/raspberrypi/firmware/trunk/boot
</span><span style="color:#ffb964;">rm</span><span> boot/kernel*
</span><span style="color:#ffb964;">rm</span><span> boot/*.dtb
</span><span style="color:#ffb964;">rm</span><span> boot/overlays/*.dtbo
</span></code></pre>
<p>安装svn， 使用svn下载树莓派官方不开源的二进制启动文件(奇怪，git 没什么便利的方法下载github仓库中某个指定目录),  我们需要boot 目录中的start4<em>elf ,   fixup4</em>dat；   删除boot目录中已有的kernel 文件， 设备树blob, overlay 文件。</p>
<pre data-lang="bash" style="background-color:#151515;color:#e8e8d3;" class="language-bash "><code class="language-bash" data-lang="bash"><span>cd  linux
</span><span style="color:#ffb964;">cp</span><span> arch/arm64/boot/Image    ../boot/kernel8.img
</span><span style="color:#ffb964;">cp</span><span> arch/arm64/boot/dts/overlays/*.dtbo    ../boot/overlays/
</span><span style="color:#ffb964;">cp</span><span> arch/arm64/boot/dts/broadcom/*.dtb     ../boot/
</span></code></pre>
<p>把刚才编译的新内核，设备树相关文件 copy  到  boot 目录</p>
<pre data-lang="bash" style="background-color:#151515;color:#e8e8d3;" class="language-bash "><code class="language-bash" data-lang="bash"><span>cd  </span><span style="color:#ffb964;">~</span><span>/boot
</span><span>
</span><span style="color:#ffb964;">cat    </span><span style="color:#99ad6a;">&lt;&lt; </span><span style="color:#8fbfdc;">EOF   </span><span>&gt;  config.txt
</span><span style="color:#99ad6a;">enable_uart=1
</span><span style="color:#99ad6a;">arm_64bit=1
</span><span style="color:#99ad6a;">kernel=u-boot.bin
</span><span style="color:#8fbfdc;">EOF
</span><span>
</span><span style="color:#ffb964;">cat </span><span style="color:#99ad6a;">&lt;&lt; </span><span style="color:#8fbfdc;">EOF   </span><span>&gt;    cmdline.txt
</span><span style="color:#99ad6a;">console=serial0,115200 console=tty1 root=/dev/mmcblk0p2 rootwait
</span><span style="color:#8fbfdc;">EOF
</span></code></pre>
<p>在boot 目录中生成config.txt (start4*elf 的配置文件) , 内核命令行参数文件cmdline.txt</p>
<pre data-lang="bash" style="background-color:#151515;color:#e8e8d3;" class="language-bash "><code class="language-bash" data-lang="bash"><span>cd  </span><span style="color:#ffb964;">~
</span><span style="color:#ffb964;">cat  </span><span style="color:#99ad6a;">&lt;&lt;</span><span style="color:#556633;">&#39;</span><span style="color:#8fbfdc;">EOF</span><span style="color:#556633;">&#39;  </span><span>&gt; boot.scr
</span><span style="color:#99ad6a;">fatload mmc 0:1 ${kernel_addr_r}   kernel8.img
</span><span style="color:#99ad6a;">fatload mmc 0:1 ${fdt_addr} bcm2711-rpi-4-b.dtb
</span><span style="color:#99ad6a;">setenv bootargs 8250.nr_uarts=1 console=ttyS0,115200 root=/dev/mmcblk0p2 rootwait rw
</span><span style="color:#99ad6a;">booti ${kernel_addr_r} - ${fdt_addr}
</span><span style="color:#8fbfdc;">EOF
</span><span>
</span><span style="color:#ffb964;">~/u-boot/tools/mkimage -A</span><span> arm64</span><span style="color:#ffb964;"> -O</span><span> linux</span><span style="color:#ffb964;"> -T</span><span> script</span><span style="color:#ffb964;"> -C</span><span> none</span><span style="color:#ffb964;"> -n</span><span> boot.scr</span><span style="color:#ffb964;">  -d</span><span> boot.scr  boot.scr.uimg
</span><span>
</span><span style="color:#ffb964;">cp</span><span>  ./boot.scr.uimg      </span><span style="color:#ffb964;">~</span><span>/boot
</span><span style="color:#ffb964;">cp  ~</span><span>/u-boot/u-boot.bin     </span><span style="color:#ffb964;">~</span><span>/boot
</span></code></pre>
<p>准备u-boot 启动脚本 boot.scr的内容， 使用u-boot 的mkimage 工具把 boot.scr 转换成 boot.scr.uimg;   最后把boot.scr.uimg 和u-boot.bin copy 到 boot 目录.</p>
<ol start="4">
<li>分区格式化SD卡,  拷贝boot 目录内容 到SD卡的 fat 分区:

  <img src="https://oscimg.oschina.net/oscnet/up-c5fa385b8f03e818debce15169330d39087.png" class="left" />

</li>
</ol>
<pre data-lang="bash" style="background-color:#151515;color:#e8e8d3;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffb964;">cp   -a  ~</span><span>/boot/*     /media/jianyu/BOOT  
</span></code></pre>
<ol start="5">
<li>准备一个简单的init 程序， 放在根文件系统，防止内核因找不到init 程序而panic ：</li>
</ol>
<p>loopInit.go:</p>
<pre data-lang="golang" style="background-color:#151515;color:#e8e8d3;" class="language-golang "><code class="language-golang" data-lang="golang"><span>package main
</span><span>
</span><span>import (
</span><span>	&quot;time&quot;
</span><span>	//&quot;fmt&quot;
</span><span>)
</span><span>
</span><span>func main(){
</span><span>	for range  time.Tick(time.Second){
</span><span>		print(&quot;\u001Bc&quot;, time.Now().Local().String(), &quot; hello, i&#39;m init process!&quot;)
</span><span>	}
</span><span>}
</span></code></pre>
<pre data-lang="bash" style="background-color:#151515;color:#e8e8d3;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffb964;">CGO_ENABLED</span><span>=</span><span style="color:#99ad6a;">0  </span><span style="color:#ffb964;">GOARCH</span><span>=</span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">arm64</span><span style="color:#556633;">&quot;   </span><span style="color:#ffb964;">go</span><span> build</span><span style="color:#ffb964;">  -o</span><span> loopInit loopInit.go
</span><span>
</span><span style="color:#ffb964;">mkdir -p</span><span>  /media/jianyu/root/bin
</span><span style="color:#ffb964;">mv</span><span>  loopInit    /media/jianyu/root/bin/init 
</span></code></pre>
<ol start="6">
<li>启动系统:</li>
</ol>
<p>使用TTL-USB 连接pi 和pc , 启动gtkterm：</p>
<pre data-lang="bash" style="background-color:#151515;color:#e8e8d3;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffb964;">sudo</span><span>  gtkterm</span><span style="color:#ffb964;"> -p</span><span> /dev/ttyUSB0</span><span style="color:#ffb964;"> -s</span><span> 115200
</span></code></pre>
<p>插上pi 的电源,u-boot 启动信息刷屏后，出现唯一的用户态程序:</p>

  <img src="https://oscimg.oschina.net/oscnet/up-c67b2c145d8b0cda01c20e92687a04437bd.png" class="left" />


        </div>

        
        <div class="pagination">
            <div class="pagination__title">
                <span class="pagination__title-h">Thanks for reading! Read other posts?</span>
                <hr />
            </div>
            <div class="pagination__buttons">
                    <span class="button previous">
                        <a href="https://unixisevil.github.io/rpi4-cross-build/">
                            <span class="button__icon">←</span>&nbsp;
                            <span class="button__text">为raspberry pi 4 构建交叉编译工具链</span>
                        </a>
                    </span>
                
                
                    <span class="button next">
                        <a href="https://unixisevil.github.io/calc-pi/">
                            <span class="button__text">計算圓周率</span>&nbsp;
                            <span class="button__icon">→</span>
                        </a>
                    </span>
                </div>
        </div>
    
    </div>

    </div>

    
    <footer class="footer">
        <div class="footer__inner">
                <div class="copyright">
                        <span>© 
    2025
 Powered by <a href="https://www.getzola.org/">Zola</a></span>
                    <span class="copyright-theme">
                        <span class="copyright-theme-sep">:: </span>
                        Theme: <a href="https://github.com/pawroman/zola-theme-terminimal/">Terminimal</a> by pawroman
                    </span>
                </div>
            </div>
    </footer>
    

</div>
</body>

</html>
