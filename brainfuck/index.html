<!DOCTYPE html>
<html lang="en">

<head>
    <title>Random Notes</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="robots" content="noodp"/>

    <link rel="stylesheet" href="https://unixisevil.github.io/style.css">
    <link rel="stylesheet" href="https://unixisevil.github.io/color/blue.css">

    <link rel="stylesheet" href="https://unixisevil.github.io/font-hack-subset.css">

    </head>

<body class="">
<div class="container">
    
    <header class="header">
        <div class="header__inner">
            <div class="header__logo">
                    
                <a href="https://unixisevil.github.io" style="text-decoration: none;">
                    <div class="logo">
                      
                            Random Notes
                        
                    </div>
                </a>
            </div>
        </div>

        
        
                <nav class="menu">
            <ul class="menu__inner">
                <li><a href="https://unixisevil.github.io">blog</a></li>
            
                <li><a href="https://unixisevil.github.io/tags">tags</a></li>
            
                <li><a href="https://unixisevil.github.io/archive">archive</a></li>
            
                <li><a href="https://my.oschina.net/evilunix">old blog</a></li>
            
                <li class="active"><a href="https://unixisevil.github.io/" target="_blank" rel="noopener noreferrer">github</a></li>
            </ul>
        </nav>
    
    
        
    </header>
    

    <div class="content">
        
    <div class="post">
        
    <h1 class="post-title"><a href="https://unixisevil.github.io/brainfuck/">The unexpected slowness of the ETS table</a></h1>
    <div class="post-meta-inline">
        
    <span class="post-date">
            2025-04-17
        </span>

    </div>

    
        <span class="post-tags-inline">
                :: tags:&nbsp;
                <a class="post-tag" href="https://unixisevil.github.io/tags/bit-string/">#bit string</a>&nbsp;
                <a class="post-tag" href="https://unixisevil.github.io/tags/brainfuck/">#brainfuck</a>&nbsp;
                <a class="post-tag" href="https://unixisevil.github.io/tags/elixir/">#elixir</a>&nbsp;
                <a class="post-tag" href="https://unixisevil.github.io/tags/ets-table/">#ets table</a>&nbsp;
                <a class="post-tag" href="https://unixisevil.github.io/tags/map/">#map</a>&nbsp;
                <a class="post-tag" href="https://unixisevil.github.io/tags/process-dict/">#process dict</a></span>
    

        
        <div class="post-content">
            <p>最近发现ets table 并不是预期中那么快, 一些immutable data structure 像map, bit string 都有可能快过ets table, 比如在实现brainfuck interpreter 的场景.</p>
<p>运行其中一个例子, 打印sierpinski 三角形:</p>
<pre data-lang="bash" style="background-color:#151515;color:#e8e8d3;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffb964;">./bf_ets_storage.exs --example</span><span> sierpinski
</span></code></pre>
<img src="/imgs/slow_ets.gif">
<pre data-lang="bash" style="background-color:#151515;color:#e8e8d3;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffb964;">./bf_bin_storage.exs --example</span><span> sierpinski
</span></code></pre>
<img src="/imgs/fast_bin.gif">
<p>观察eprofile的结果, 过滤其中ets 相关:</p>
<pre data-lang="bash" style="background-color:#151515;color:#e8e8d3;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffb964;">******</span><span> Process &lt;</span><span style="color:#cf6a4c;">0</span><span>.95.</span><span style="color:#cf6a4c;">0</span><span>&gt;    -- 100.00 % of profiled time ***
</span><span style="color:#ffb964;">FUNCTION</span><span>                                              CALLS        %       TIME  </span><span style="color:#8fbfdc;">[</span><span>uS / CALLS</span><span style="color:#8fbfdc;">]
</span><span style="color:#ffb964;">--------</span><span>                                              -----  -------       ----  </span><span style="color:#8fbfdc;">[</span><span>----------</span><span style="color:#8fbfdc;">]
</span><span style="color:#ffb964;">ets:new/2</span><span>                                                 1     0.00          7  </span><span style="color:#8fbfdc;">[</span><span>      7.00</span><span style="color:#8fbfdc;">]
</span><span style="color:#ffb964;">ets:insert/2</span><span>                                              1     0.00       4156  </span><span style="color:#8fbfdc;">[</span><span>   4156.00</span><span style="color:#8fbfdc;">]
</span><span style="color:#ffb964;">ets:update_counter/3</span><span>                                 126577     0.04      39000  </span><span style="color:#8fbfdc;">[</span><span>      0.31</span><span style="color:#8fbfdc;">]
</span><span style="color:#ffb964;">ets:select/2</span><span>                                          73265    99.67  102147914  </span><span style="color:#8fbfdc;">[</span><span>   1394.23</span><span style="color:#8fbfdc;">]
</span></code></pre>
<p>ets:select/2  调用十分频繁而且每次调用开销不低, 使用ets table 模拟 brainfuck 机器的内存, 如果在get, set, incr, decr 等读写memory cell api 处加上dbg()观察, 会存在一些连续对同一个cell 的读取, 如果能cache 读取调用, 可能会有改善.</p>
<pre data-lang="bash" style="background-color:#151515;color:#e8e8d3;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffb964;">[bf_ets_storage.exs:29:</span><span> BrainFuck.EtsCell.incr/2]
</span><span style="color:#ffb964;">idx </span><span style="color:#888888;">#=&gt; 0
</span><span>
</span><span style="color:#ffb964;">[bf_ets_storage.exs:29:</span><span> BrainFuck.EtsCell.incr/2]
</span><span style="color:#ffb964;">idx </span><span style="color:#888888;">#=&gt; 0
</span><span>
</span><span style="color:#ffb964;">[bf_ets_storage.exs:29:</span><span> BrainFuck.EtsCell.incr/2]
</span><span style="color:#ffb964;">idx </span><span style="color:#888888;">#=&gt; 0
</span><span style="color:#ffb964;">....
</span><span style="color:#ffb964;">....
</span></code></pre>
<p>另外存在上述连续对同一个cell 自增操作, 可以做合并做一次写入, 可能优化的解释器,编译器会利用一些重复的code模式做优化, 像<a href="https://github.com/Wilfred/bfc">bfc</a>, 还没看过.</p>
<p>写代码过程中发现elixir不支持递归匿名函数，搜索后发现发现一个<a href="https://dev.to/lucassperez/recursive-anonymous-function-in-elixir-pn3">trick</a> 可以像这样写, 引入一个额外的参数来表达匿名函数自身:</p>
<pre data-lang="elixir" style="background-color:#151515;color:#e8e8d3;" class="language-elixir "><code class="language-elixir" data-lang="elixir"><span>find = </span><span style="color:#8fbfdc;">fn</span><span> location, unmatched_brackets, f -&gt;
</span><span>      </span><span style="color:#8fbfdc;">cond do
</span><span>        location &lt; </span><span style="color:#cf6a4c;">0 </span><span>or location &gt;= byte_size(source_code) -&gt;
</span><span>          </span><span style="color:#ffb964;">IO</span><span>.puts(</span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">Error: could not find match for #{</span><span>start_bracket}</span><span style="color:#99ad6a;"> at #{</span><span>start}</span><span style="color:#99ad6a;">.</span><span style="color:#556633;">&quot;</span><span>)
</span><span>          start
</span><span>
</span><span>        true -&gt;
</span><span>          </span><span style="color:#8fbfdc;">case </span><span style="color:#7697d6;">:binary</span><span>.at(source_code, location) </span><span style="color:#8fbfdc;">do
</span><span>            </span><span style="color:#ffb964;">^end_bracket </span><span>-&gt;
</span><span>              </span><span style="color:#8fbfdc;">if</span><span> unmatched_brackets == </span><span style="color:#cf6a4c;">0 </span><span style="color:#8fbfdc;">do
</span><span>                location
</span><span>              </span><span style="color:#8fbfdc;">else
</span><span>                f.(location + direction, unmatched_brackets - </span><span style="color:#cf6a4c;">1</span><span>, f)
</span><span>              </span><span style="color:#8fbfdc;">end
</span><span>
</span><span>            </span><span style="color:#ffb964;">^start_bracket </span><span>-&gt;
</span><span>              f.(location + direction, unmatched_brackets + </span><span style="color:#cf6a4c;">1</span><span>, f)
</span><span>
</span><span>            _ -&gt;
</span><span>              f.(location + direction, unmatched_brackets, f)
</span><span>          </span><span style="color:#8fbfdc;">end
</span><span>      </span><span style="color:#8fbfdc;">end
</span><span>    </span><span style="color:#8fbfdc;">end
</span><span>
</span><span>    find.(location, unmatched_brackets, find)
</span></code></pre>
<p>评论区有人说这是<a href="https://matt.might.net/articles/implementation-of-recursive-fixed-point-y-combinator-in-javascript-for-memoization/">Y Combinator</a>, elixir 中保存递归调用中的状态, 可以使用<a href="https://hexdocs.pm/elixir/Process.html#put/2">process dictionary</a>.</p>
<p>使用map, bit string, process dictionary 来模拟brainfuck 的memory cell 都比使用ets table 要快.
<a href="https://gist.github.com/unixisevil/e1d872a2af73c282b244c23ef4309818">full source code</a></p>

        </div>

        
        <div class="pagination">
            <div class="pagination__title">
                <span class="pagination__title-h">Thanks for reading! Read other posts?</span>
                <hr />
            </div>
            <div class="pagination__buttons">
                    <span class="button previous">
                        <a href="https://unixisevil.github.io/laziness/">
                            <span class="button__icon">←</span>&nbsp;
                            <span class="button__text">Traps of Laziness</span>
                        </a>
                    </span>
                
                </div>
        </div>
    
    </div>

    </div>

    
    <footer class="footer">
        <div class="footer__inner">
                <div class="copyright">
                        <span>© 
    2025
 Powered by <a href="https://www.getzola.org/">Zola</a></span>
                    <span class="copyright-theme">
                        <span class="copyright-theme-sep">:: </span>
                        Theme: <a href="https://github.com/pawroman/zola-theme-terminimal/">Terminimal</a> by pawroman
                    </span>
                </div>
            </div>
    </footer>
    

</div>
</body>

</html>
