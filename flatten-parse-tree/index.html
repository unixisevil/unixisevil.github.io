<!DOCTYPE html>
<html lang="en">

<head>
    <title>Random Notes</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="robots" content="noodp"/>

    <link rel="stylesheet" href="https://unixisevil.github.io/style.css">
    <link rel="stylesheet" href="https://unixisevil.github.io/color/blue.css">

    <link rel="stylesheet" href="https://unixisevil.github.io/font-hack-subset.css">

    </head>

<body class="">
<div class="container">
    
    <header class="header">
        <div class="header__inner">
            <div class="header__logo">
                    
                <a href="https://unixisevil.github.io" style="text-decoration: none;">
                    <div class="logo">
                      
                            Random Notes
                        
                    </div>
                </a>
            </div>
        </div>

        
        
                <nav class="menu">
            <ul class="menu__inner">
                <li><a href="https://unixisevil.github.io">blog</a></li>
            
                <li><a href="https://unixisevil.github.io/tags">tags</a></li>
            
                <li><a href="https://unixisevil.github.io/archive">archive</a></li>
            
                <li><a href="https://my.oschina.net/evilunix">old blog</a></li>
            
                <li class="active"><a href="https://unixisevil.github.io/" target="_blank" rel="noopener noreferrer">github</a></li>
            </ul>
        </nav>
    
    
        
    </header>
    

    <div class="content">
        
    <div class="post">
        
    <h1 class="post-title"><a href="https://unixisevil.github.io/flatten-parse-tree/">carbon 如何表达解析树</a></h1>
    <div class="post-meta-inline">
        
    <span class="post-date">
            2023-12-18
        </span>

    </div>

    
        <span class="post-tags-inline">
                :: tags:&nbsp;
                <a class="post-tag" href="https://unixisevil.github.io/tags/carbon/">#carbon</a>&nbsp;
                <a class="post-tag" href="https://unixisevil.github.io/tags/rust/">#rust</a>&nbsp;
                <a class="post-tag" href="https://unixisevil.github.io/tags/tree/">#tree</a></span>
    

        
        <div class="post-content">
            <p>之前看到<a href="https://www.youtube.com/watch?v=ZI198eFghJk&amp;t=3684s&amp;ab_channel=CppNow">Chandler Carruth介绍关于现代化carbon编译器工具链</a>的视频, carbon 的parse tree 的实现不再基于指针来构造tree, 使用cache 友好的动态数组表达.</p>
<p><a href="https://www.cs.cornell.edu/~asampson/blog/flattening.html">想起Adrian Sampson的blog也再讲Flattening AST</a>也是使用vector存储表达式节点，然后使用整数索引替换指针.</p>
<p>无独有偶rust的编译器内部也是大量使用整数id的数据结构, 像是<a href="https://doc.rust-lang.org/stable/nightly-rustc/rustc_data_structures/graph/implementation/struct.Graph.html">graph的实现</a>, <a href="https://doc.rust-lang.org/stable/nightly-rustc/rustc_ast/node_id/struct.NodeId.html">AST node的表达</a>等等.</p>
<p>carbon 的parse tree 实现相对比较容易理解, 以下我用rust代码大致解释其实现:</p>
<pre data-lang="rust" style="background-color:#151515;color:#e8e8d3;" class="language-rust "><code class="language-rust" data-lang="rust"><span>use index_vec::{index_vec, IndexVec};
</span><span>
</span><span style="color:#8fbfdc;">fn </span><span style="color:#fad07a;">main</span><span>() {
</span><span>    </span><span style="color:#8fbfdc;">let mut</span><span> tree = Tree::&lt;</span><span style="color:#8fbfdc;">char</span><span>&gt;::new();
</span><span>
</span><span>    </span><span style="color:#8fbfdc;">let</span><span> b = tree.new_node(</span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">b</span><span style="color:#556633;">&#39;</span><span>);
</span><span>    </span><span style="color:#8fbfdc;">let</span><span> c = tree.new_node(</span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">c</span><span style="color:#556633;">&#39;</span><span>);
</span><span>    </span><span style="color:#8fbfdc;">let</span><span> h = tree.new_node(</span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">h</span><span style="color:#556633;">&#39;</span><span>);
</span><span>    </span><span style="color:#8fbfdc;">let</span><span> d = tree.new_node(</span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">d</span><span style="color:#556633;">&#39;</span><span>);
</span><span>    tree.add_child(d, h);
</span><span>
</span><span>    </span><span style="color:#8fbfdc;">let</span><span> i = tree.new_node(</span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">i</span><span style="color:#556633;">&#39;</span><span>);
</span><span>    </span><span style="color:#8fbfdc;">let</span><span> p = tree.new_node(</span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">p</span><span style="color:#556633;">&#39;</span><span>);
</span><span>    </span><span style="color:#8fbfdc;">let</span><span> q = tree.new_node(</span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">q</span><span style="color:#556633;">&#39;</span><span>);
</span><span>    </span><span style="color:#8fbfdc;">let</span><span> j = tree.new_node(</span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">j</span><span style="color:#556633;">&#39;</span><span>);
</span><span>    tree.add_child(j, p);
</span><span>    tree.add_child(j, q);
</span><span>    </span><span style="color:#8fbfdc;">let</span><span> e = tree.new_node(</span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">e</span><span style="color:#556633;">&#39;</span><span>);
</span><span>    tree.add_child(e, i);
</span><span>    tree.add_child(e, j);
</span><span>
</span><span>    </span><span style="color:#8fbfdc;">let</span><span> k = tree.new_node(</span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">k</span><span style="color:#556633;">&#39;</span><span>);
</span><span>    </span><span style="color:#8fbfdc;">let</span><span> l = tree.new_node(</span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">l</span><span style="color:#556633;">&#39;</span><span>);
</span><span>    </span><span style="color:#8fbfdc;">let</span><span> m = tree.new_node(</span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">m</span><span style="color:#556633;">&#39;</span><span>);
</span><span>    </span><span style="color:#8fbfdc;">let</span><span> f = tree.new_node(</span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">f</span><span style="color:#556633;">&#39;</span><span>);
</span><span>    tree.add_child(f, k);
</span><span>    tree.add_child(f, l);
</span><span>    tree.add_child(f, m);
</span><span>
</span><span>    </span><span style="color:#8fbfdc;">let</span><span> n = tree.new_node(</span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">n</span><span style="color:#556633;">&#39;</span><span>);
</span><span>    </span><span style="color:#8fbfdc;">let</span><span> g = tree.new_node(</span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">g</span><span style="color:#556633;">&#39;</span><span>);
</span><span>    tree.add_child(g, n);
</span><span>
</span><span>    </span><span style="color:#8fbfdc;">let</span><span> a = tree.new_node(</span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">a</span><span style="color:#556633;">&#39;</span><span>);
</span><span>    tree.add_child(a, b);
</span><span>    tree.add_child(a, c);
</span><span>    tree.add_child(a, d);
</span><span>    tree.add_child(a, e);
</span><span>    tree.add_child(a, f);
</span><span>    tree.add_child(a, g);
</span><span>
</span><span>    tree.postorder_subtree(e);
</span><span>    println!();
</span><span>    </span><span style="color:#8fbfdc;">for</span><span> c in tree.postorder_children(e) {
</span><span>        println!(</span><span style="color:#556633;">&quot;</span><span style="color:#7697d6;">{c:?}</span><span style="color:#99ad6a;">, </span><span style="color:#7697d6;">{:?}</span><span style="color:#556633;">&quot;</span><span>, tree.nodes[c]);
</span><span>    }
</span><span>    println!();
</span><span>    </span><span style="color:#8fbfdc;">for</span><span> c in tree.children(e) {
</span><span>        println!(</span><span style="color:#556633;">&quot;</span><span style="color:#7697d6;">{c:?}</span><span style="color:#99ad6a;">, </span><span style="color:#7697d6;">{:?}</span><span style="color:#556633;">&quot;</span><span>, tree.nodes[c]);
</span><span>    }
</span><span>    println!();
</span><span>    </span><span style="color:#8fbfdc;">let mut</span><span> buf = String::new();
</span><span>    tree.postorder_yaml(&amp;</span><span style="color:#8fbfdc;">mut</span><span> buf);
</span><span>    println!(</span><span style="color:#556633;">&quot;</span><span style="color:#7697d6;">{buf}</span><span style="color:#556633;">&quot;</span><span>);
</span><span>
</span><span>    buf.clear();
</span><span>    tree.preorder_yaml(&amp;</span><span style="color:#8fbfdc;">mut</span><span> buf);
</span><span>    println!(</span><span style="color:#556633;">&quot;</span><span style="color:#7697d6;">{buf}</span><span style="color:#556633;">&quot;</span><span>);
</span><span>}
</span><span>
</span><span>
</span><span>index_vec::define_index_type! {
</span><span>    </span><span style="color:#8fbfdc;">pub struct </span><span style="color:#ffb964;">NodeRef</span><span> = u32;
</span><span>    </span><span style="color:#7697d6;">MAX_INDEX </span><span>= (</span><span style="color:#8fbfdc;">u32</span><span>::max_value() - </span><span style="color:#cf6a4c;">1</span><span>) as </span><span style="color:#8fbfdc;">usize</span><span>;
</span><span>    </span><span style="color:#7697d6;">DEFAULT </span><span>= NodeRef::from_raw_unchecked(</span><span style="color:#8fbfdc;">u32</span><span>::max_value());
</span><span>    </span><span style="color:#7697d6;">IMPL_RAW_CONVERSIONS </span><span>= true;
</span><span>    </span><span style="color:#7697d6;">DISABLE_MAX_INDEX_CHECK </span><span>= cfg!(not(debug_assertions));
</span><span>}
</span><span>
</span><span>#[</span><span style="color:#ffb964;">derive</span><span>(Debug)]
</span><span style="color:#8fbfdc;">struct </span><span style="color:#ffb964;">Node</span><span>&lt;T: std::fmt::Debug&gt; {
</span><span>    </span><span style="color:#ffb964;">value</span><span>: T,
</span><span>    </span><span style="color:#ffb964;">subtree_size</span><span>: </span><span style="color:#8fbfdc;">isize</span><span>,
</span><span>}
</span><span>
</span><span style="color:#8fbfdc;">struct </span><span style="color:#ffb964;">ChildrenIter</span><span>&lt;</span><span style="color:#8fbfdc;">&#39;a</span><span>, T: std::fmt::Debug&gt; {
</span><span>    </span><span style="color:#ffb964;">tree</span><span>: &amp;</span><span style="color:#8fbfdc;">&#39;a </span><span>Tree&lt;T&gt;,
</span><span>    </span><span style="color:#ffb964;">curr</span><span>: </span><span style="color:#8fbfdc;">isize</span><span>,
</span><span>    </span><span style="color:#ffb964;">end</span><span>: </span><span style="color:#8fbfdc;">isize</span><span>,
</span><span>}
</span><span>
</span><span style="color:#8fbfdc;">impl</span><span>&lt;</span><span style="color:#8fbfdc;">&#39;a</span><span>, T: std::fmt::Debug&gt; Iterator for </span><span style="color:#ffb964;">ChildrenIter</span><span>&lt;</span><span style="color:#8fbfdc;">&#39;a</span><span>, T&gt; {
</span><span>    </span><span style="color:#8fbfdc;">type </span><span style="color:#ffb964;">Item </span><span>= NodeRef;
</span><span>    </span><span style="color:#8fbfdc;">fn </span><span style="color:#fad07a;">next</span><span>(&amp;</span><span style="color:#8fbfdc;">mut </span><span style="color:#ffb964;">self</span><span>) -&gt; Option&lt;</span><span style="color:#8fbfdc;">Self::</span><span>Item&gt; {
</span><span>        </span><span style="color:#8fbfdc;">if </span><span style="color:#ffb964;">self</span><span>.curr &lt;= </span><span style="color:#ffb964;">self</span><span>.end {
</span><span>            </span><span style="color:#8fbfdc;">return </span><span>None;
</span><span>        }
</span><span>        </span><span style="color:#8fbfdc;">let</span><span> curr_tree_size = </span><span style="color:#ffb964;">self</span><span>.tree.nodes[</span><span style="color:#ffb964;">self</span><span>.curr as </span><span style="color:#8fbfdc;">usize</span><span>].subtree_size;
</span><span>        </span><span style="color:#8fbfdc;">let</span><span> ret = </span><span style="color:#ffb964;">self</span><span>.curr;
</span><span>        </span><span style="color:#ffb964;">self</span><span>.curr -= curr_tree_size;
</span><span>        Some(NodeRef::from(ret as </span><span style="color:#8fbfdc;">usize</span><span>))
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#8fbfdc;">impl</span><span>&lt;T: std::fmt::Debug&gt; </span><span style="color:#ffb964;">Node</span><span>&lt;T&gt; {
</span><span>    </span><span style="color:#8fbfdc;">fn </span><span style="color:#fad07a;">new</span><span>(</span><span style="color:#ffb964;">val</span><span>: T) -&gt; </span><span style="color:#8fbfdc;">Self </span><span>{
</span><span>        </span><span style="color:#8fbfdc;">Self </span><span>{
</span><span>            value: val,
</span><span>            subtree_size: </span><span style="color:#cf6a4c;">1</span><span>,
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#8fbfdc;">struct </span><span style="color:#ffb964;">Tree</span><span>&lt;T: std::fmt::Debug&gt; {
</span><span>    </span><span style="color:#ffb964;">nodes</span><span>: IndexVec&lt;NodeRef, Node&lt;T&gt;&gt;,
</span><span>}
</span><span>
</span><span style="color:#8fbfdc;">impl</span><span>&lt;T: std::fmt::Debug&gt; </span><span style="color:#ffb964;">Tree</span><span>&lt;T&gt; {
</span><span>    </span><span style="color:#8fbfdc;">fn </span><span style="color:#fad07a;">new</span><span>() -&gt; </span><span style="color:#8fbfdc;">Self </span><span>{
</span><span>        </span><span style="color:#8fbfdc;">Self </span><span>{
</span><span>            nodes: index_vec![],
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#8fbfdc;">fn </span><span style="color:#fad07a;">with_capacity</span><span>(</span><span style="color:#ffb964;">cap</span><span>: </span><span style="color:#8fbfdc;">usize</span><span>) -&gt; </span><span style="color:#8fbfdc;">Self </span><span>{
</span><span>        </span><span style="color:#8fbfdc;">Self </span><span>{
</span><span>            nodes: IndexVec::with_capacity(cap),
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#8fbfdc;">fn </span><span style="color:#fad07a;">new_node</span><span>(&amp;</span><span style="color:#8fbfdc;">mut </span><span style="color:#ffb964;">self</span><span>, </span><span style="color:#ffb964;">val</span><span>: T) -&gt; NodeRef {
</span><span>        </span><span style="color:#ffb964;">self</span><span>.nodes.push(Node::new(val))
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#8fbfdc;">fn </span><span style="color:#fad07a;">add_child</span><span>(&amp;</span><span style="color:#8fbfdc;">mut </span><span style="color:#ffb964;">self</span><span>, </span><span style="color:#ffb964;">p</span><span>: NodeRef, </span><span style="color:#ffb964;">c</span><span>: NodeRef) {
</span><span>        </span><span style="color:#ffb964;">self</span><span>.nodes[p].subtree_size += </span><span style="color:#ffb964;">self</span><span>.nodes[c].subtree_size;
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#8fbfdc;">fn </span><span style="color:#fad07a;">children</span><span>(&amp;</span><span style="color:#ffb964;">self</span><span>, </span><span style="color:#ffb964;">n</span><span>: NodeRef) -&gt; ChildrenIter&lt;&#39;_, T&gt; {
</span><span>        ChildrenIter {
</span><span>            tree: </span><span style="color:#ffb964;">self</span><span>,
</span><span>            curr: </span><span style="color:#8fbfdc;">usize</span><span>::from(n) as </span><span style="color:#8fbfdc;">isize </span><span>- </span><span style="color:#cf6a4c;">1</span><span>,
</span><span>            end: </span><span style="color:#8fbfdc;">usize</span><span>::from(n) as </span><span style="color:#8fbfdc;">isize </span><span>- </span><span style="color:#ffb964;">self</span><span>.nodes[n].subtree_size,
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#8fbfdc;">fn </span><span style="color:#fad07a;">postorder_children</span><span>(&amp;</span><span style="color:#ffb964;">self</span><span>, </span><span style="color:#ffb964;">n</span><span>: NodeRef) -&gt; Vec&lt;NodeRef&gt; {
</span><span>        </span><span style="color:#8fbfdc;">let mut</span><span> pos: Vec&lt;NodeRef&gt; = </span><span style="color:#ffb964;">self</span><span>.children(n).collect();
</span><span>        pos.reverse();
</span><span>        pos
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#8fbfdc;">fn </span><span style="color:#fad07a;">size</span><span>(&amp;</span><span style="color:#ffb964;">self</span><span>, </span><span style="color:#ffb964;">n</span><span>: NodeRef) -&gt; </span><span style="color:#8fbfdc;">isize </span><span>{
</span><span>        </span><span style="color:#ffb964;">self</span><span>.nodes[n].subtree_size
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#8fbfdc;">fn </span><span style="color:#fad07a;">postorder</span><span>(&amp;</span><span style="color:#ffb964;">self</span><span>) {
</span><span>        </span><span style="color:#8fbfdc;">for</span><span> e in </span><span style="color:#ffb964;">self</span><span>.nodes.iter() {
</span><span>            println!(</span><span style="color:#556633;">&quot;</span><span style="color:#7697d6;">{:?}</span><span style="color:#556633;">&quot;</span><span>, e);
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#8fbfdc;">fn </span><span style="color:#fad07a;">postorder_subtree</span><span>(&amp;</span><span style="color:#ffb964;">self</span><span>, </span><span style="color:#ffb964;">n</span><span>: NodeRef) {
</span><span>        </span><span style="color:#8fbfdc;">let</span><span> end_pos = n + </span><span style="color:#cf6a4c;">1</span><span>;
</span><span>        </span><span style="color:#8fbfdc;">let</span><span> start_pos = end_pos - </span><span style="color:#ffb964;">self</span><span>.size(n) as </span><span style="color:#8fbfdc;">usize</span><span>;
</span><span>        </span><span style="color:#8fbfdc;">for</span><span> e in &amp;</span><span style="color:#ffb964;">self</span><span>.nodes[start_pos..end_pos] {
</span><span>            println!(</span><span style="color:#556633;">&quot;</span><span style="color:#7697d6;">{e:?}</span><span style="color:#556633;">&quot;</span><span>);
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#8fbfdc;">fn </span><span style="color:#fad07a;">yaml_node</span><span>(&amp;</span><span style="color:#ffb964;">self</span><span>, </span><span style="color:#ffb964;">buf</span><span>: &amp;</span><span style="color:#8fbfdc;">mut</span><span> String, </span><span style="color:#ffb964;">n</span><span>: NodeRef, </span><span style="color:#ffb964;">depth</span><span>: </span><span style="color:#8fbfdc;">u32</span><span>, </span><span style="color:#ffb964;">preorder</span><span>: </span><span style="color:#8fbfdc;">bool</span><span>) -&gt; </span><span style="color:#8fbfdc;">bool </span><span>{
</span><span>        </span><span style="color:#8fbfdc;">let</span><span> indent = </span><span style="color:#556633;">&quot; &quot;</span><span>.repeat(</span><span style="color:#cf6a4c;">2 </span><span>* (depth as </span><span style="color:#8fbfdc;">usize </span><span>+ </span><span style="color:#cf6a4c;">1</span><span>));
</span><span>        buf.push_str(&amp;indent);
</span><span>        buf.push(</span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">{</span><span style="color:#556633;">&#39;</span><span>);
</span><span>        </span><span style="color:#8fbfdc;">if</span><span> preorder {
</span><span>            buf.push_str(&amp;format!(</span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">node_index: </span><span style="color:#7697d6;">{n:?}</span><span style="color:#99ad6a;">, </span><span style="color:#556633;">&quot;</span><span>));
</span><span>        }
</span><span>        buf.push_str(&amp;format!(</span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">value: </span><span style="color:#7697d6;">{:?}</span><span style="color:#556633;">&quot;</span><span>, </span><span style="color:#ffb964;">self</span><span>.nodes[n].value));
</span><span>        </span><span style="color:#8fbfdc;">if </span><span style="color:#ffb964;">self</span><span>.size(n) &gt; </span><span style="color:#cf6a4c;">1 </span><span>{
</span><span>            buf.push_str(&amp;format!(</span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">, subtree_size: </span><span style="color:#7697d6;">{}</span><span style="color:#556633;">&quot;</span><span>, </span><span style="color:#ffb964;">self</span><span>.size(n)));
</span><span>            </span><span style="color:#8fbfdc;">if</span><span> preorder {
</span><span>                buf.push_str(</span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">, children: [\n</span><span style="color:#556633;">&quot;</span><span>);
</span><span>                </span><span style="color:#8fbfdc;">return </span><span>true;
</span><span>            }
</span><span>        }
</span><span>        buf.push(</span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">}</span><span style="color:#556633;">&#39;</span><span>);
</span><span>        false
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#8fbfdc;">fn </span><span style="color:#fad07a;">postorder_yaml</span><span>(&amp;</span><span style="color:#ffb964;">self</span><span>, </span><span style="color:#ffb964;">buf</span><span>: &amp;</span><span style="color:#8fbfdc;">mut</span><span> String) {
</span><span>        </span><span style="color:#8fbfdc;">let mut</span><span> indents = vec![</span><span style="color:#cf6a4c;">0</span><span style="color:#8fbfdc;">u32</span><span>; </span><span style="color:#ffb964;">self</span><span>.nodes.len()];
</span><span>        </span><span style="color:#8fbfdc;">let mut</span><span> stack = Vec::&lt;(NodeRef, </span><span style="color:#8fbfdc;">u32</span><span>)&gt;::with_capacity(</span><span style="color:#cf6a4c;">16</span><span>);
</span><span>
</span><span>        stack.push((NodeRef::from(</span><span style="color:#ffb964;">self</span><span>.nodes.len() - </span><span style="color:#cf6a4c;">1</span><span>), </span><span style="color:#cf6a4c;">0</span><span>));
</span><span>        </span><span style="color:#8fbfdc;">while let </span><span>Some((n, depth)) = stack.pop() {
</span><span>            </span><span style="color:#8fbfdc;">for</span><span> c in </span><span style="color:#ffb964;">self</span><span>.children(n) {
</span><span>                indents[</span><span style="color:#8fbfdc;">usize</span><span>::from(c)] = depth + </span><span style="color:#cf6a4c;">1</span><span>;
</span><span>                stack.push((c, depth + </span><span style="color:#cf6a4c;">1</span><span>));
</span><span>            }
</span><span>        }
</span><span>        buf.push_str(</span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">[\n</span><span style="color:#556633;">&quot;</span><span>);
</span><span>        </span><span style="color:#8fbfdc;">for</span><span> n in </span><span style="color:#cf6a4c;">0</span><span>..</span><span style="color:#ffb964;">self</span><span>.nodes.len() {
</span><span>            </span><span style="color:#ffb964;">self</span><span>.yaml_node(buf, NodeRef::from(n), indents[n], false);
</span><span>            buf.push_str(</span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">,\n</span><span style="color:#556633;">&quot;</span><span>);
</span><span>        }
</span><span>        buf.push_str(</span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">]\n</span><span style="color:#556633;">&quot;</span><span>);
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#8fbfdc;">fn </span><span style="color:#fad07a;">preorder_yaml</span><span>(&amp;</span><span style="color:#ffb964;">self</span><span>, </span><span style="color:#ffb964;">buf</span><span>: &amp;</span><span style="color:#8fbfdc;">mut</span><span> String) {
</span><span>        </span><span style="color:#8fbfdc;">let mut</span><span> stack = Vec::&lt;(NodeRef, </span><span style="color:#8fbfdc;">u32</span><span>)&gt;::with_capacity(</span><span style="color:#cf6a4c;">16</span><span>);
</span><span>        stack.push((NodeRef::from(</span><span style="color:#ffb964;">self</span><span>.nodes.len() - </span><span style="color:#cf6a4c;">1</span><span>), </span><span style="color:#cf6a4c;">0</span><span>));
</span><span>        buf.push_str(</span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">[\n</span><span style="color:#556633;">&quot;</span><span>);
</span><span>        </span><span style="color:#8fbfdc;">while let </span><span>Some((n, depth)) = stack.pop() {
</span><span>            </span><span style="color:#8fbfdc;">if </span><span style="color:#ffb964;">self</span><span>.yaml_node(buf, n, depth, true) {
</span><span>                </span><span style="color:#8fbfdc;">for</span><span> c in </span><span style="color:#ffb964;">self</span><span>.children(n) {
</span><span>                    stack.push((c, depth + </span><span style="color:#cf6a4c;">1</span><span>));
</span><span>                }
</span><span>                </span><span style="color:#8fbfdc;">continue</span><span>;
</span><span>            }
</span><span>            </span><span style="color:#8fbfdc;">let</span><span> next_depth = </span><span style="color:#8fbfdc;">if</span><span> stack.is_empty() {
</span><span>                </span><span style="color:#cf6a4c;">0
</span><span>            } </span><span style="color:#8fbfdc;">else </span><span>{
</span><span>                stack.last().unwrap().</span><span style="color:#cf6a4c;">1
</span><span>            };
</span><span>            assert!(next_depth &lt;= depth);
</span><span>            </span><span style="color:#8fbfdc;">for </span><span>_ in </span><span style="color:#cf6a4c;">0</span><span>..(depth - next_depth) {
</span><span>                buf.push_str(</span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">]}</span><span style="color:#556633;">&quot;</span><span>);
</span><span>            }
</span><span>            buf.push_str(</span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">  ,\n</span><span style="color:#556633;">&quot;</span><span>);
</span><span>        }
</span><span>        buf.push_str(</span><span style="color:#556633;">&quot;</span><span style="color:#99ad6a;">]\n</span><span style="color:#556633;">&quot;</span><span>);
</span><span>    }
</span><span>}
</span></code></pre>
<p>main 函数中构造了一颗这样的树:</p>
<img src="/imgs/tree.svg">
<p>tree节点在vector中的存储顺序是post order, 因为parse过程会采用递归下降，自底向上地构造parse tree 或者AST.</p>
<img src="/imgs/vec.svg">
<p>顺便值得一提，<a href="https://kroki.io/">kroki</a>很好用的在线画图工具，支持GraphViz code.</p>
<p>postorder_yaml方法，打印post order的yaml:</p>
<pre data-lang="yaml" style="background-color:#151515;color:#e8e8d3;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span>[
</span><span>    {</span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">b</span><span style="color:#556633;">&#39;</span><span>},
</span><span>    {</span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">c</span><span style="color:#556633;">&#39;</span><span>},
</span><span>      {</span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">h</span><span style="color:#556633;">&#39;</span><span>},
</span><span>    {</span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">d</span><span style="color:#556633;">&#39;</span><span>, </span><span style="color:#ffb964;">subtree_size</span><span>: </span><span style="color:#cf6a4c;">2</span><span>},
</span><span>      {</span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">i</span><span style="color:#556633;">&#39;</span><span>},
</span><span>        {</span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">p</span><span style="color:#556633;">&#39;</span><span>},
</span><span>        {</span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">q</span><span style="color:#556633;">&#39;</span><span>},
</span><span>      {</span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">j</span><span style="color:#556633;">&#39;</span><span>, </span><span style="color:#ffb964;">subtree_size</span><span>: </span><span style="color:#cf6a4c;">3</span><span>},
</span><span>    {</span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">e</span><span style="color:#556633;">&#39;</span><span>, </span><span style="color:#ffb964;">subtree_size</span><span>: </span><span style="color:#cf6a4c;">5</span><span>},
</span><span>      {</span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">k</span><span style="color:#556633;">&#39;</span><span>},
</span><span>      {</span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">l</span><span style="color:#556633;">&#39;</span><span>},
</span><span>      {</span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">m</span><span style="color:#556633;">&#39;</span><span>},
</span><span>    {</span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">f</span><span style="color:#556633;">&#39;</span><span>, </span><span style="color:#ffb964;">subtree_size</span><span>: </span><span style="color:#cf6a4c;">4</span><span>},
</span><span>      {</span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">n</span><span style="color:#556633;">&#39;</span><span>},
</span><span>    {</span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">g</span><span style="color:#556633;">&#39;</span><span>, </span><span style="color:#ffb964;">subtree_size</span><span>: </span><span style="color:#cf6a4c;">2</span><span>},
</span><span>  {</span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">a</span><span style="color:#556633;">&#39;</span><span>, </span><span style="color:#ffb964;">subtree_size</span><span>: </span><span style="color:#cf6a4c;">16</span><span>},
</span><span>]
</span></code></pre>
<p>preorder_yaml方法，打印pre order的yaml:</p>
<pre data-lang="yaml" style="background-color:#151515;color:#e8e8d3;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span>[
</span><span>  {</span><span style="color:#ffb964;">node_index</span><span>: </span><span style="color:#cf6a4c;">15</span><span>, </span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">a</span><span style="color:#556633;">&#39;</span><span>, </span><span style="color:#ffb964;">subtree_size</span><span>: </span><span style="color:#cf6a4c;">16</span><span>, </span><span style="color:#ffb964;">children</span><span>: [
</span><span>    {</span><span style="color:#ffb964;">node_index</span><span>: </span><span style="color:#cf6a4c;">0</span><span>, </span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">b</span><span style="color:#556633;">&#39;</span><span>}  ,
</span><span>    {</span><span style="color:#ffb964;">node_index</span><span>: </span><span style="color:#cf6a4c;">1</span><span>, </span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">c</span><span style="color:#556633;">&#39;</span><span>}  ,
</span><span>    {</span><span style="color:#ffb964;">node_index</span><span>: </span><span style="color:#cf6a4c;">3</span><span>, </span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">d</span><span style="color:#556633;">&#39;</span><span>, </span><span style="color:#ffb964;">subtree_size</span><span>: </span><span style="color:#cf6a4c;">2</span><span>, </span><span style="color:#ffb964;">children</span><span>: [
</span><span>      {</span><span style="color:#ffb964;">node_index</span><span>: </span><span style="color:#cf6a4c;">2</span><span>, </span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">h</span><span style="color:#556633;">&#39;</span><span>}]}  ,
</span><span>    {</span><span style="color:#ffb964;">node_index</span><span>: </span><span style="color:#cf6a4c;">8</span><span>, </span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">e</span><span style="color:#556633;">&#39;</span><span>, </span><span style="color:#ffb964;">subtree_size</span><span>: </span><span style="color:#cf6a4c;">5</span><span>, </span><span style="color:#ffb964;">children</span><span>: [
</span><span>      {</span><span style="color:#ffb964;">node_index</span><span>: </span><span style="color:#cf6a4c;">4</span><span>, </span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">i</span><span style="color:#556633;">&#39;</span><span>}  ,
</span><span>      {</span><span style="color:#ffb964;">node_index</span><span>: </span><span style="color:#cf6a4c;">7</span><span>, </span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">j</span><span style="color:#556633;">&#39;</span><span>, </span><span style="color:#ffb964;">subtree_size</span><span>: </span><span style="color:#cf6a4c;">3</span><span>, </span><span style="color:#ffb964;">children</span><span>: [
</span><span>        {</span><span style="color:#ffb964;">node_index</span><span>: </span><span style="color:#cf6a4c;">5</span><span>, </span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">p</span><span style="color:#556633;">&#39;</span><span>}  ,
</span><span>        {</span><span style="color:#ffb964;">node_index</span><span>: </span><span style="color:#cf6a4c;">6</span><span>, </span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">q</span><span style="color:#556633;">&#39;</span><span>}]}]}  ,
</span><span>    {</span><span style="color:#ffb964;">node_index</span><span>: </span><span style="color:#cf6a4c;">12</span><span>, </span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">f</span><span style="color:#556633;">&#39;</span><span>, </span><span style="color:#ffb964;">subtree_size</span><span>: </span><span style="color:#cf6a4c;">4</span><span>, </span><span style="color:#ffb964;">children</span><span>: [
</span><span>      {</span><span style="color:#ffb964;">node_index</span><span>: </span><span style="color:#cf6a4c;">9</span><span>, </span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">k</span><span style="color:#556633;">&#39;</span><span>}  ,
</span><span>      {</span><span style="color:#ffb964;">node_index</span><span>: </span><span style="color:#cf6a4c;">10</span><span>, </span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">l</span><span style="color:#556633;">&#39;</span><span>}  ,
</span><span>      {</span><span style="color:#ffb964;">node_index</span><span>: </span><span style="color:#cf6a4c;">11</span><span>, </span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">m</span><span style="color:#556633;">&#39;</span><span>}]}  ,
</span><span>    {</span><span style="color:#ffb964;">node_index</span><span>: </span><span style="color:#cf6a4c;">14</span><span>, </span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">g</span><span style="color:#556633;">&#39;</span><span>, </span><span style="color:#ffb964;">subtree_size</span><span>: </span><span style="color:#cf6a4c;">2</span><span>, </span><span style="color:#ffb964;">children</span><span>: [
</span><span>      {</span><span style="color:#ffb964;">node_index</span><span>: </span><span style="color:#cf6a4c;">13</span><span>, </span><span style="color:#ffb964;">value</span><span>: </span><span style="color:#556633;">&#39;</span><span style="color:#99ad6a;">n</span><span style="color:#556633;">&#39;</span><span>}]}]}  ,
</span><span>]
</span></code></pre>

        </div>

        
        <div class="pagination">
            <div class="pagination__title">
                <span class="pagination__title-h">Thanks for reading! Read other posts?</span>
                <hr />
            </div>
            <div class="pagination__buttons">
                    <span class="button previous">
                        <a href="https://unixisevil.github.io/linklist-sorting/">
                            <span class="button__icon">←</span>&nbsp;
                            <span class="button__text">link list sorting</span>
                        </a>
                    </span>
                
                
                    <span class="button next">
                        <a href="https://unixisevil.github.io/footgun-async-rust/">
                            <span class="button__text">footguns in async rust</span>&nbsp;
                            <span class="button__icon">→</span>
                        </a>
                    </span>
                </div>
        </div>
    
    </div>

    </div>

    
    <footer class="footer">
        <div class="footer__inner">
                <div class="copyright">
                        <span>© 
    2025
 Powered by <a href="https://www.getzola.org/">Zola</a></span>
                    <span class="copyright-theme">
                        <span class="copyright-theme-sep">:: </span>
                        Theme: <a href="https://github.com/pawroman/zola-theme-terminimal/">Terminimal</a> by pawroman
                    </span>
                </div>
            </div>
    </footer>
    

</div>
</body>

</html>
